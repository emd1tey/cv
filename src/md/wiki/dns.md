DNS - это клиент-серверная система.  Серверы(dns) загружают данные из клиентских DNS-файлов в память и используются при ответах на внешние и внтуренние запросы. Все компуктеры должны быть dns клиентами, но как минимум один должен быть dns сервером.

Есть прямое и обратное преобразование. Прямое преобразование связывает домен с ip. Обратное - ip с доменом. # не точно. необходимо проверить.

Классификация серверов имен:\

| Тип сервера                        | Описание                                                                                     |
| ---------------------------------- | -------------------------------------------------------------------------------------------- |
| Авторитетный сервер                | Официальный представитель зоны                                                               |
| Главный (master)                   | Основное хранилище зоны                                                                      |
| Подчиненный ( slave)               | Копирует данные с мастера                                                                    |
| Усеченный (stub)                   | копирует данные c мастера только о серверах имен ns(ns записи) # не понятно для чего покачто |
| Внутренний(distribution)           | Сервер достный только в пределах домена(невидимый сервер) # не понятно для чего              |
| Неавторитетный (non-authoritative) | отвечает на запросы исползуя кеш                                                             |
| Кеширующий(caching)                | Кеширует ответы от полученных ответов                                                        |
| Переадресющий(forwarder)           | Выполняет запросы от клиентов DNS сервера. Формирует кеш                                     |
| Рекурсивный                        | Осуществляет запросы от имени клиенты, пока не полчит ответ                                  |
| Нерекурсивный                      | Отсылает клиента к другому сервреу, если не может получить ответ на запрос                   |

 Главный, подчиненный, кеширующий отличаются двумя характерстиками:\
- откуда поступают данные
- авторитетен ли сервер для домена
BIND может быть всеми тремя
NSD - только  главным или подчиненным
Unbound - только кеширующий. Кеширующий сервер позваляет сократить DNS трафик во внутреней сети + уменьшает время ответа выполнения запроса.

Рекурсивные и нерекурсивные сервера. Рекурсивный сервер должен быть доступен только для подсети. Если он доступен из вне его могут положить,( либо использовать как DNS рычаг при DDOS.не точно)

DNS запись: [имя][ttl][класс][тип][данные]

- Имя - google.com
- TTL - время жизни записи в кеше
- классы:
            * in(internet);
            * hs(hesiod - служба каталогово, локально используемая в некоторых организация. Для чего пока не ясно) - надстройка на BIND разработана массачусетсским технологическим университетом
            *  ch(chaosnet - служб, используемая на некоторых серверах имен для самоидентификации) - сетевой протокол. применялся на lisp-машинах компании symbolics. На текущий момент в пределах класса ch скрыта информация о версии dns-сервера и имя узла на котором запущен dns сервер. [Использование CHAOSNET для сбора информации](https://xakep.ru/2017/09/19/hack-contest-dns-dig/), [[usiung_chaos_net | Использование CHAOSNET для сбора информации о DNS сервере]]

Записи базы данных DNS:\

| ---                   | Тип    | Имя               | Назначение                                                               |
| --------------------- | ------ | ----------------- | ------------------------------------------------------------------------ |
| Зонные                | SOA    | Start of Authrity | Определение DNS-зоны                                                     |
| :::                   | NS     | Name Server       | Оперделение серверов имен зоны, делигирование полномочий поддоменам      |
| Базовые               | A      | IPv4 Adress       | Преобразование имени в IPv4 Адрес                                        |
| :::                   | AAAA   | IPv6 Adress       | Преобразование  имени в IPv6 Адрес                                       |
| :::                   | PTR    | Pointer           | Преобразование адреса в имя                                              |
| :::                   | MX     | Mail Exchanger    | Управление маршрутизацией почты                                          |
| Безопасность и DNSSEC | DS     | Deligation Signer | Хеширует подписанный ключ дочерней зоны                                  |
| :::                   | DNSKEY | Public Key        | Открытый ключ для имени DNS                                              |
| :::                   | NSEC   | Next Secure       | Используется вместе со спецификацией DNSSEC для  генерации отказов       |
| :::                   | NSEC3  | Next Secure v3    | Используется вместе со спецификацией DNSSEC для  генерации отказов       |
| :::                   | RRSIG  | Signature         | Множество подписанных аутентифицированных записей о ресурсах             |
| :::                   | DLV    | Lookaside         | Некорневая точка доверия для спецификации DNSSEC                         |
| :::                   | SSHFP  | SSH fingerprint   | SSH-ключ узла позволяющий верификацию с помощью DNS                      |
| :::                   | SPF    | Sender Policy     | Идентификация почтоввых серверов, запрещает  подделку писем              |
| :::                   | DKIM   | Domain Keys       | Проверят отправителя сообщения электронной почты и целостность сообщения |
| Вспомогательные       | CNAME  | Canonical Name    | Дополнительные именя(псевдонимы узла)                                    |
| :::                   | SRV    | Services          | Местонахождения известных служб в пределах домена                        |
| :::                   | TXT    | Text              | Комментарии или нестандартная информация*                                |
*Записи тхт исползуются для того чтобы не ожидат одобрения IETF для введения новых типов записей. Пример SPF и DKIM записи.
####  SOA-запись
SOA-запись - группа записей о ресурсах, расположенных в одной точке пространства имен DNS. Пример

| Домен        | TTL до обновления кеша | Класс записи | Тип записи | Авторитетный сервер | Почта для связи. Пишется не через @. А через точку. Т.е. support.hoster.by соответсвует почте support@hoster.by | порядковый номер | временные интервалы хранения записи в кеше в различных базах глобальных DNS серверов(?)<br>Как часто подчиненный связывается с авторитетным для проверки не поменялся ли порядковый номер зоны | Если подчиенный пытается узнать порядковый номер у auth-сервера а тот offline - выполнение повторной проверки | как долго обслуживать запись, если отсутсвует auth-сервер | время существования отриц.ответа в кеше |
| ------------ | ---------------------- | ------------ | ---------- | ------------------- | --------------------------------------------------------------------------------------------------------------- | ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- | --------------------------------------- |
| bagna.of.by. | 600                    | IN           | SOA        | u1.hoster.by.       | support.hoster.by.                                                                                              | 2020012403       | 43200                                                                                                                                                                                          | 7200                                                                                                          | 604800                                                    | 600                                     |

? -неточно. требует уточнения.

####  Запись NS

Записи NS - идентифируют серверы имен, которые авторитетны для зоны(т.е. все главные и подчиненные серверы), а также делегируют полномочия по управления поддоменами другим организациям.

| Зона               | ttl | класс | тип | имя узла      |
| ------------------ | --- | ----- | --- | ------------- |
| ;; ANSWER SECTION: |     |       |     |               |
| bagna.of.by.       | 600 | IN    | NS  | u2.hoster.by. |
|bagna.of.by.|600|IN|NS|u1.hoster.by.|

####  Запись А

Запись вида А = основаная часть базы данных DNS. Обеспечивает перевод имени в ip адрес

| имя узла     | ttl | класс | тип | ip-адрес        |
| ------------ | --- | ----- | --- | --------------- |
| bagna.of.by. | 600 | IN    | A   | 178.172.236.118 |


####  Запись PTR

PTR запись обеспечивает обратный перевод IP-адреса в доменное имя.

| адрес | ttl | класс | тип | имя узла |
| ----- | --- | ----- | --- | -------- |
||||||

####  MX запись

MX записи используются системой электронной почты для более эффективной маршрутизации почтовых сообщений. Запись MX подменяет адресата сообщения, в большинстве случаев направляя сообщение концетратору электронной почты на сервере получаетеля. Сначала опрашиваются с низким числовым приоритетом. Наиболее низкий 65535,наиболее высокий - 0.

| имя         | ttl | класс | тип | приоритет | узел           |
| ----------- | --- | ----- | --- | --------- | -------------- |
| iknow.of.by | 600 | IN    | MX  | 10        | mx.yandex.net. |


####  Запись CNAME

Запись Сname - позволяет назначить узлу дополнительное мнемоническое имя.
Обнаружив запись CNAME, ПО DNS перестает посылать запроы по мнемоническому имени и переключается на реальное имя. Длинна цепочки записей CNAME не должна составлять больше восьми элементов. Цепочка - когда одна cname запись ссылается на другую cname запись, а другая на третью  т.д. Последним элементом цепочки должно быть реальное имя узла, а не псевдоним.  При использовании cname ptr должна ссылаться на реальное имя, а не псевдоним.

| Псевдоним         | ttl | класс | тип   | имя узла                |
| ----------------- | --- | ----- | ----- | ----------------------- |
| mail.iknow.of.by. | 600 | IN    | CNAME | domain.mail.yandex.net. |

####  SRV

Эти записи определяют местонахождение служб в пределах домена. Запись SRV определана в RFC2782. Записи SRV напоминает MX записи с доп.полями, которые позволяют  адмнистратору управлять внешними соединениями и  распределять нагрузку на сервер.
 Формат записи:\

| служба.протокол.имя                                           | ttl  | класс | тип | приоритет | вес | порт | сервер                   |
| ------------------------------------------------------------- | ---- | ----- | --- | --------- | --- | ---- | ------------------------ |
| _ftp.tcp                                                      | 7200 | IN    | SRV | 0         | 0   | 21   | ftp-server.atrust.com.   |
| 1/4 ssh соединений обслуживается старым сервером. 3/4 новым   |      |       |     |           |     |      |                          |
| _ssh.tcp                                                      | 7200 | IN    | SRV | 0         | 1   | 22   | old-slow-box.atrust.com. |
| _ssh.tcp                                                      | 7200 | IN    | SRV | 0         | 3   | 22   | new-fast-box.atrust.com. |
| Основной сервер досступен через 80 порт. Резервный через 8000 |      |       |     |           |     |      |                          |
| _http.tcp                                                     | 3600 | IN    | SRV | 0         | 0   | 80   | www-server.atrust.com.   |
| _http.tcp                                                     | 3600 | IN    | SRV | 10        | 0   | 8000 | new-fast-box.atrust.com. |
|В адресной строе можно указывать как  http://atrus.com, так и http://www.atrus.com||||||||
|_http.tcp.www|3600|IN|SRV|0|0|80|www-server.atrust.com.|
| _http.tcp.www | 3600 | IN  | SRV | 0   | 0   | 8000 | new-fast-box.atrust.com. |
| ------------- | ---- | --- | --- | --- | --- | ---- | ------------------------ |
|Все осталные службы блокированы||||||||
| *._tcp | 7200 | IN  | SRV | 0   | 0   | 0   | .   |
| ------ | ---- | --- | --- | --- | --- | --- | --- |
| *._udp | 7200 | IN  | SRV | 0   | 0   | 0   | .   |

В примре демонстрируется использование весов для ssh, приоритеты для http.Задействованы оба ssh сервера с развесовкой нагрузки. Введен резервный  http сервер. Все остальные службы заблокированы. То, что службы недоступны в системе DNS не означает, что они на самом деле не выполняются. Пример использваония srv - MS Exchange использует SRV для того, чтобы настройки outlook автоматически прописывались.

####  Записи  TXT

| имя | ttl | класс | тип | Информация |
| --- | --- | ----- | --- | ---------- |
|bagna.of.by|600|IN|txt|v=spf1 ip4:178.172.236.118 +a +mx ~all|
 Информация может быть произвольной. Информация о компании и т.д. TXT запись идет сразу после soa и ns.

####  Записи SPF(Исключена из RFC. Работает через txt)

Записи SPF предназначены для идентиикации сообщений электронной почты с поддеьным заголовком FROM. Если сервер получившй сообщение, определяет, что его заголовок подделан, он может удалить его, профильтровать или пометить как спам. Функция изначально реализована через txt. Почтовый сервер может читать и txt и spf синтаксис у них одинаковый.
Формат:\

|имя|ttl|класс|тип|значение|
| ----------- | --- | --- | --- | -------------------------------------- |
| bagna.of.by | 600 | IN  | SPF | v=spf1 ip4:178.172.236.118 +a +mx ~all |

####  Записи АААА

|имя|ttl|класс|тип|значение|
| --------------- | ---- | --- | ---- | ----------------- |
| vh69.hoster.by. | 3600 | IN  | AAAA | 2a0a:7d80:1:7::69 |

####  PTR AAAA
 Тоже есть как посмотреть хз

####  DKIM и ADSP
Появилась в результате слияяния двух систем:\
    * DomainKeys от компании yahoo
    * Identified Internet Mail от Cisco
Получаетль сообщения может аутентифицировать его отправителя(подлинность) и гарантировать его целостность(отсутсвие постороннего вмешательства)

**Определен в [[https://www.ietf.org/rfc/rfc4871.txt]]**

Пока отдельная запись еще не стандартизирована так, как для остальних DNS записей. На текущий момент используется особы формат TXT записи. Формат записи состоит из имени записи DNS и конкатенирования "селектора" и строки _domainkey. В записи хранится открытый ключ. Может существовать несколько селекторов. При отправке письма с подписью DKIM сервер вычисляет с помощью спец.полей загловка и тела сообщения подпись и подписывает сообщение. Подпись помещается в поле DKIM-siganture. При получении сообщения подпись проверяется с помощью DKIM-signature открытго ключа. Успешная верификация сообщения гарантирует, что сообщение не изменилось.

Пример подписанного сообщения:\

`//ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;`
        `h=date:message-id:content-transfer-encoding:mime-version:subject:to`
         `:from;`
        `bh=PXR+0wO5EOROaHEM/YNCaP7m06lY5uxdbdH6B4I8Mak=;`
        `b=o5YuoQI6Ea40Bb2ZztzIHSegob4O1/6uXZUOnj67Yb7Sks/XC5D/nqojfUTYuBP8rG`
         `pP9+lf05CdwP8GE5fyAiHezBmibJnQ44SNNxf0xPsSKUxpnN8Pe4yCaP0SdC30QMVvsA`
         `x0JhKC5laFdMIpB1Ak9bU/Mu4ZQkKPzz38KWXhZKvzc3VARLqMVa628a37VFCldcVPAs`
         `yn82C2ZA/pq9aWprHON+iekcsvddM6RBi8BMsPLAu8fFvOKgspyxDNIWlCzjQdhJYQlO`
         `6jIfDLq6roFCRXGMmVY+eJW3xldCYa099KWCtnBO1LpAzXzHaQKsu0jb9DTOoQwOGClq`
         `hdFA==//`

Разберем дескрипторы письма:\

| Раздел | RFC | Описание |
| ------ | --- | -------- |
|i |     1|Номер версии|
| a   | rsa-sha256       | Алгоритм шифрования rsa-sha1 ли rsa-sha256                                                                               |
| --- | ---------------- | ------------------------------------------------------------------------------------------------------------------------ |
| c   | relaxed/relaxed; | Алгоритм канонизаци: simple или relaxd. Данным параметром определеяется как изменяется заголовок и тело перед шифрование |
| d   | google.com       | Домен отправителя                                                                                                        |
| s   | arc-signatura    | Селектор или имя ключа                                                                                                   |
| h   |                  | Поля заголовка для включения в подпись заголовка                                                                         |
|bh| |Хэш тела сообщения|
|b| |Криптографическая подпись всего сообщения|

DNS запись:\

| Имя                          | TTL | класс | тип | Значение                               |
| ---------------------------- | --- | ----- | --- | -------------------------------------- |
| mail._domainkey.bagna.of.by. | 600 | IN    | TXT | v=DKIM1; k=rsa; t=s; p=MIGfMA0GCSqG... |

Разберем значение:\

| v=DKIM1;                | Версия протокла подписи |
| ----------------------- | ----------------------- |
| k=rsa;                  | алгоритм шифрованиея    |
| t=s;                    | ?                       |
| p=MIGfMA0xaLgwIDAQAB... | Ключ                    |

####  Запись SSHFP **RFC 4255 и RFC 6594**

DNS записи sshfp позваляет программе ssh проверить ключ узла гарантируя, что пользователь будет соединен с требуемой машиной

Пример:\

|  имя  |  ttl  |класс|тип|алгоритм|алгоритм фингерпринта|фингерпринт|
| ------------------ | ---- | --- | ----- | --- | --- | -------------------------------- |
| server.example.net | 3600 | IN  | SSHFP | 1   | 1   | ( dd465c09cfa51fb45020cc83316fff |


|Алгоритм|Алгоритм public key|алгоритм фингерпринта|
| ---------- | --------- | --------- |
| ---------- | --------- | --------- |
|RSA with SHA1|  1  |  1  |
|RSA with SHA-256|  1  |  2  |
|DSA with sha1|  2  |  1  |
|DSA with sha-256|  2  |  2  |
|ECDSA with sha1|  3  |  1  |
|ECDSA with sha-256|  3  |  2  |

####  Записи о ресурсах DNSSEC

C DNSSEC ассоциируется шесть типов записи. Записи DS, DVL, DNSKEY -  предназачены для хранения разнообразных ключей и их отпечатков. RRSIG - содержит подписи других записей в зоне. NSEC и NSEC3 позволяет серверам подписывать несуществующие записи, обеспечиват криптографическую безопасность при отпрацтельных ответах на запросы. Отличаются от других тем, что генеируются программно, а не набираются вручную.

** Тут отделно надо курить спецификацию ***

###  Передача зоны между  мастером и подчиненным

Осуществляется через TSIG и TKEY
